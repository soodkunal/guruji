function g8_step3_conv_txt_to_wav(){
    echo "  + Converting the lecture text into an audio file..."

    # Ask prof ID and fetch its voice_id from DB
    echo -n "Enter Professor ID: "
    read prof_id
    if [ -z "$prof_id" ]; then echo "[ERROR] Professor ID required."; return 1; fi

    voice_id=$(sqlite3 "$DB_FILE" "SELECT voice_id FROM voice_ids WHERE professor_id='$prof_id';")
    if [ -z "$voice_id" ]; then
        echo "[ERROR] No voice_id found for professor $prof_id. Assign a voice first."; return 1
    fi
    echo "  + Using Professor ID: $prof_id with Voice ID: $voice_id"

    # Choose source text: current env file or latest generated for this prof
    if [ -f "$G8_OPS_GPT_TXT" ]; then
        SRC_TXT="$G8_OPS_GPT_TXT"
    else
        SRC_TXT=$(ls -t "$G8_PROJ_DIR/ops/g8_ops_gpt_${prof_id}_*.txt" 2>/dev/null | head -n1)
        if [ -z "$SRC_TXT" ]; then
            echo "[ERROR] No lecture text found. Run Step 2 first."; return 1
        fi
        echo "  + Using latest GPT text file: $SRC_TXT"
    fi

    TEXT_CONTENT=$(cat "$SRC_TXT")

    # Build payload (NOTE: pass bash vars with --arg and reference as $voice)
    JSON_PAYLOAD=$(jq -n \
        --arg text "$TEXT_CONTENT" \
        --arg voice "$voice_id" \
        '{
            text: $text,
            voice: $voice,
            stability: 0.5,
            similarity: 0.5
        }')

    # Use per-voice endpoint
    ELAB_TTS_URL="https://api.elevenlabs.io/v1/text-to-speech/$voice_id"

    RESPONSE=$(curl -s -X POST "$ELAB_TTS_URL" \
        -H "xi-api-key: $G8_ELAB_KEY" \
        -H "Content-Type: application/json" \
        -d "$JSON_PAYLOAD")

    AUDIO_URL=$(echo "$RESPONSE" | jq -r '.audio_url // empty')
    if [ -z "$AUDIO_URL" ] || [ "$AUDIO_URL" = "null" ]; then
        echo "[ERROR] ElevenLabs did not return an audio URL. Full response:"
        echo "$RESPONSE"
        return 1
    fi

    echo "  + Downloading the audio file..."
    curl -s -o "$G8_OPS_AUDIO_FILE" "$AUDIO_URL"

    if [ -f "$G8_OPS_AUDIO_FILE" ]; then
        echo "  + Audio file saved at: $G8_OPS_AUDIO_FILE"
    else
        echo "[ERROR] Failed to download audio file."
        return 1
    fi
}
